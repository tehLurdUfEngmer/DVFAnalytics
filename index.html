<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Immobilier</title>
    </head>

    <body>
        <h1>Highcharts</h1>
		<fieldset id = "zone1">
			<label for="codePostal">Code Postal:</label>
			<input type="text" placeholder="CODE POSTAL" id="codePostal" maxlength = "5" /><br/>
			<label for="surfaceMin">Surface habitable Minimale:</label>
			<input type="number" placeholder="Surface Min" id="surfaceMin"/><br/>
			<label for="surfaceMax">Surface Habitable Maximale:</label>
			<input type="number" placeholder="Surface Max" id="surfaceMax"/><br/>
			<label for="typeLogement">Type de logement:</label>
			<select name="typeLogement" id="listeLogement">
			  <option value="1">Maison</option>
			  <option value="2">Appartement</option>
			  <option value="a">Autre</option>
			  <option value="t">Tous</option>
			</select>
		</fieldset>
    <div id="envoi">
      <input type="button" value="Requêter" id="request"/>
    <div>
		<div id="graphique1"></div>
		<hr/>
		<div id="boxplot"></div>

		<!--
		<script src="https://code.highcharts.com/mapdata/countries/fr/fr-all.js"></script>
		<script src="https://code.highcharts.com/maps/highmaps.js"></script>
		<script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
		-->
		<script src="https://code.highcharts.com/highcharts.js"></script>
		<script src="https://code.highcharts.com/highcharts-more.js"></script>
		<script src="https://code.highcharts.com/modules/series-label.js"></script>
		<script src="https://code.highcharts.com/modules/exporting.js"></script>
		<script src="https://code.highcharts.com/modules/export-data.js"></script>
		<script src="//rawgithub.com/phpepe/highcharts-regression/master/highcharts-regression.js"></script>

    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io.connect('http://localhost:8080');
      document.getElementById("listeLogement").onchange = function(){
        const optionTab = [1,2,3,4,5];
        const optionTextTab = ["Studio ou T1","T2","T3","T4","T5"]
        const selectId = "taille";
        if(!document.getElementById(selectId) && document.getElementById("listeLogement").value == 2){
          // generation sous liste
          generateSelect({id_select: selectId, optionValues: optionTab, textTab: optionTextTab});
        }else if(document.getElementById(selectId)){
          // sinon suppression de la liste
          document.getElementById("zone1").removeChild(document.getElementById(selectId));
        }


      }


			// envoi des msg chat + nettoyage de la zone texte apres envoi
			document.getElementById("request").onclick = function(){
				// mettre tests de bonne données.
				const codePostal = document.getElementById("codePostal").value;
				const surfaceMin = document.getElementById("surfaceMin").value;
				const surfaceMax = document.getElementById("surfaceMax").value;
				const typeLog = document.getElementById("listeLogement").value;
        if(document.getElementById("taille")){
          var tailleLog = document.getElementById("taille").value;
        }else{
          var tailleLog = 0;
        }
				// envoi des infos au serveur
				socket.emit("request",{typlog: typeLog,cp : codePostal, smin : surfaceMin, smax : surfaceMax, nbpce : tailleLog});
			}
			// reception données statistiques
			socket.on("stats_basic", function(stats){

				console.log(stats.data);
				// graphique boite a moustaaaache
				Highcharts.chart('boxplot', {
					chart: {
						type: 'boxplot'
					},
					title: {
						text: 'Boite a Moustache (par semestre)'
					},
					subtitle: {
						text: 'Données aberrantes supprimées<br/>règle : |obs - mean| < 3 * std',
						useHTML: true,
						floating: true
					},
					legend: {
						enabled: false
					},
					xAxis: {
						categories: stats.categories,
						title: {
							text: 'Semestre (Date)'
						}
					},
					yAxis: {
						title: {
							text: 'Observations'
						},
						labels: {
							format: '{value} €/m²'
						}
					},
					series: [{
						name: 'Observations',
						data: stats.data,
						tooltip: {
							headerFormat: '<em>Semestre {point.key}</em><br/>'
						}
					}/*, {
						name: 'Outlier',
						color: Highcharts.getOptions().colors[0],
						type: 'scatter',
						data: [ // x, y positions where 0 is the first category
							[0, 644],
							[4, 718],
							[4, 951],
							[4, 969]
						],
						marker: {
							fillColor: 'white',
							lineWidth: 1,
							lineColor: Highcharts.getOptions().colors[0]
						},
						tooltip: {
							pointFormat: 'Observation: {point.y}'
						}
					}*/]

				});
			});

			// reception des données graphiques
			socket.on("data", function(data){
				// logs et tests
				//console.log(new Date(data[0].dateMutation).getTime());
				//console.log(typeof new Date(data[0].dateMutation).getTime());
				//console.log(data);

				// initialisation des tableaux du graphe
				Highcharts.chart('graphique1', {
					chart: {
						type: 'scatter',
						zoomType: 'x'
					},
					title: {
						text: 'Prix de l\'immobilier (2014-2018)'
					},

					subtitle: {
						text: 'Source: opendata.gouv.fr'
					},
					xAxis: {
						title: {
							enabled: true,
							text: 'Datetime'
						},
						type: 'datetime'
					},
					yAxis: {
						title: {
							text: 'Prix'
						},
						labels: {
							format: '{value} €/m²'
						}
					},
					legend: {
						layout: 'vertical',
						align: 'right',
						verticalAlign: 'middle'
					},
					tooltip: {
						xDateFormat: '%Y-%m-%d',
						shared: true
					},

					plotOptions: {
						scatter: {
							marker: {
								radius: 5,
								states: {
									hover: {
										enabled: true,
										lineColor: 'rgb(100,100,100)'
									}
								}
							},
							states: {
								hover: {
									marker: {
										enabled: false
									}
								}
							},
							tooltip: {
								headerFormat: '<b>{series.name}</b><br>',
								pointFormat: 'date: {point.x}, {point.y} eur'
							}
						},
						series: {
							turboThreshold: 10000
						}
					},

					series: [{
						regression: data.regressions[0],
						regressionSettings: {
							type: 'linear',
							color : 'blue'
						},
						name: 'Maison<br>Pente: '+data.pentes[0],
						data: data.dataHouse,
						color : 'blue',
						dataLabels:{
							formatter: function () { return new Date(this.x).toISOString(); }
						}
					}, {
						regression: data.regressions[1],
						regressionSettings: {
							type: 'linear',
							color : 'red'
						},
						name: 'Appartement<br>Pente: '+data.pentes[1],
						data: data.dataFlat,
						color : 'red'
					}, {
						regression: data.regressions[2],
						regressionSettings: {
							type: 'linear',
							color : 'green'
						},
						name: 'Autre<br>Pente: '+data.pentes[2],
						data: data.dataOther,
						color : 'green'
					}]
					/*responsive: {
						rules: [{
							condition: {
								maxWidth: 500
							},
							chartOptions: {
								legend: {
									layout: 'horizontal',
									align: 'center',
									verticalAlign: 'bottom'
								}
							}
						}]
					}*/

				});
			});

        function generateSelect(obj){
          /*
      			- id_select: id du select a creer
      			- optionValues: liste des attributs 'values' a creer dans les <option>
      			- textTab: listes des textes a inserer dans les <option>
      		*/
          // création d'un label + saut de ligne
          if(document.getElementById("lbl_"+obj.id_select)){
            var selectList = document.createElement("select");
        		selectList.setAttribute("id",obj.id_select);

        		obj.optionValues.forEach(function(value){
        			var option = document.createElement("option");
        			option.setAttribute("value",value);
        			option.innerHTML+= obj.textTab[obj.optionValues.indexOf(value)];
        			selectList.appendChild(option);
            });
            document.getElementById("zone1").appendChild(selectList);
          }
          else{
            var label = document.createElement("label");
        		label.setAttribute("for",obj.id_select);
            label.setAttribute("id","lbl_"+obj.id_select);
        		label.innerHTML += "Catégorie: ";
        		const sautLigne = document.createElement("br");
        		// Selection Appartement
        		var selectList = document.createElement("select");
        		selectList.setAttribute("id",obj.id_select);

        		obj.optionValues.forEach(function(value){
        			var option = document.createElement("option");
        			option.setAttribute("value",value);
        			option.innerHTML+= obj.textTab[obj.optionValues.indexOf(value)];
        			selectList.appendChild(option);
            });
            document.getElementById("zone1").appendChild(sautLigne);
            document.getElementById("zone1").appendChild(label);
            document.getElementById("zone1").appendChild(selectList);
          }
        }
        </script>
    </body>
</html>
