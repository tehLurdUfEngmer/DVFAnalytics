<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Immobilier</title>
        <link href="/style.css" type="text/css" rel="stylesheet">
    </head>

    <body>
        <h1>Highcharts -- DVF (Demandes de Valeurs Foncières)</h1>
        <h3><i>Author : TehLurdUfEngmer</i></h3>
		<fieldset id = "zone1">
			<label for="codePostal">Code Postal:</label>
			<input type="text" placeholder="CODE POSTAL" id="codePostal" maxlength = "5" /><br/>
			<label for="surfaceMin">Surface habitable Minimale:</label>
			<input type="number" placeholder="Surface Min" id="surfaceMin"/><br/>
			<label for="surfaceMax">Surface Habitable Maximale:</label>
			<input type="number" placeholder="Surface Max" id="surfaceMax"/><br/>
      <label for="typePrix">Terrain ?
        <label class="switch">
          <input type="checkbox" id ="avecTerrain">
          <span class="slider"></span>
        </label>
      </label></br>
      <div id="formTerrain" hidden>
      <label for="surfaceMinTerrain">Surface Terrain Minimale:</label>
			<input type="number" placeholder="Surface Min" id="surfaceMinTerrain" min="0"/><br/>
			<label for="surfaceMaxTerrain">Surface Terrain Maximale:</label>
			<input type="number" placeholder="Surface Max" id="surfaceMaxTerrain" min="1"/>
      </div>
			<label for="typeLogement">Type de logement:</label>
			<select name="typeLogement" id="listeLogement">
			  <option value="1">Maison</option>
			  <option value="2">Appartement</option>
			  <option value="a">Autre</option>
			  <option value="t">Tous</option>
			</select><br/>
      <label for="typePrix">Type de valeur : (€|€/m²)
        <label class="switch">
          <input type="checkbox" id ="typePrix">
          <span class="slider"></span>
        </label>
      </label>
		</fieldset>
    <div id="envoi">
      <input type="button" value="Requêter" id="request"/>
    <div>
    <div class="container" id="container">
  		<div id="graphique1"></div>
  		<div id="boxplot"></div>
      <div class="map" id="map"></div>

      </div>
    </div>

		<!--
		<script src="https://code.highcharts.com/mapdata/countries/fr/fr-all.js"></script>
		<script src="https://code.highcharts.com/maps/highmaps.js"></script>
		<script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
		-->
		<script src="https://code.highcharts.com/highcharts.js"></script>
		<script src="https://code.highcharts.com/highcharts-more.js"></script>
		<script src="https://code.highcharts.com/modules/series-label.js"></script>
		<script src="https://code.highcharts.com/modules/exporting.js"></script>
		<script src="https://code.highcharts.com/modules/export-data.js"></script>
		<script src="//rawgithub.com/phpepe/highcharts-regression/master/highcharts-regression.js"></script>

    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="/vendor/vendor.js"></script>
    <script type="text/javascript" src="/map.js"></script>

    <script>
      var socket = io.connect('http://localhost:8080');

      //gestion affichage formulaire du terrain
      document.getElementById("avecTerrain").onchange = function(){

        var estCoche = document.getElementById('avecTerrain').checked;
        switch (estCoche) {
          case true:// afficher
            document.getElementById('formTerrain').hidden = false;
            break;
          case false:// cacher
            document.getElementById('formTerrain').hidden = true;
            break;
        }

      }

      //gestion surface min Terrain
      document.getElementById("surfaceMinTerrain").onchange = function(){
        var actualValMin = document.getElementById('surfaceMinTerrain').value;
        if(actualValMin > document.getElementById('surfaceMaxTerrain').value){
          document.getElementById('surfaceMaxTerrain').value = actualValMin;
        }
      }
      //gestion surface max Terrain
      document.getElementById("surfaceMaxTerrain").onchange = function(){
        var actualValMax = document.getElementById('surfaceMaxTerrain').value;
        if(actualValMax < document.getElementById('surfaceMinTerrain').value){
          document.getElementById('surfaceMinTerrain').value = actualValMax;
        }
      }
      //gestion surface min Habitable
      document.getElementById("surfaceMin").onchange = function(){
        var actualValMin = document.getElementById('surfaceMin').value;
        if(actualValMin > document.getElementById('surfaceMax').value){
          document.getElementById('surfaceMax').value = actualValMin;
        }
      }
      //gestion surface max habitable
      document.getElementById("surfaceMax").onchange = function(){
        var actualValMax = document.getElementById('surfaceMax').value;
        if(actualValMax < document.getElementById('surfaceMin').value){
          document.getElementById('surfaceMin').value = actualValMax;
        }
      }

      // gestion liste type logement
      document.getElementById("listeLogement").onchange = function(){
        const optionTab = [0,1,2,3,4,5];
        const optionTextTab = ["Tous","Studio ou T1","T2","T3","T4","T5"]
        const selectId = "taille";
        if(!document.getElementById(selectId) && document.getElementById("listeLogement").value == 2){
          // generation sous liste
          generateSelect({id_select: selectId, optionValues: optionTab, textTab: optionTextTab});
        }else if(document.getElementById(selectId)){
          // sinon suppression de la liste
          document.getElementById("zone1").removeChild(document.getElementById(selectId));
        }


      }


			// envoi des msg chat + nettoyage de la zone texte apres envoi
			document.getElementById("request").onclick = function(){
				// mettre tests de bonne données.
				var codePostal = document.getElementById("codePostal").value;
				var surfaceMin = document.getElementById("surfaceMin").value;
				var surfaceMax = document.getElementById("surfaceMax").value;
        var terrainCoche = document.getElementById("avecTerrain").checked;
        var surfaceMinTerrain = document.getElementById("surfaceMinTerrain").value;
				var surfaceMaxTerrain = document.getElementById("surfaceMaxTerrain").value;
				var typeLog = document.getElementById("listeLogement").value;
        var typePrix = document.getElementById("typePrix").checked;

        switch (terrainCoche) {
          case false:// envoi null
            surfaceMinTerrain = null;
            surfaceMaxTerrain = null;
            break;
        }

        if(document.getElementById("taille")){
          var tailleLog = document.getElementById("taille").value;
        }else{
          var tailleLog = 0;
        }
				// envoi des infos au serveur
				socket.emit("request",{typlog: typeLog,cp : codePostal, smint : surfaceMinTerrain, smaxt : surfaceMaxTerrain, smin : surfaceMin, smax : surfaceMax, nbpce : tailleLog, typprix: typePrix});
			}
			// reception données statistiques
			socket.on("stats_basic", function(stats){
        /*
          - priceType: label d'unité
          - categories : Array boxPlotCategories
          - data : Array boxPlotdata
        */
				//console.log(stats.data);
				// graphique boite a moustaaaache

				Highcharts.chart('boxplot', {
					chart: {
						type: 'boxplot'
					},
					title: {
						text: 'Boite a Moustache (par semestre)'
					},
					subtitle: {
						text: 'Données aberrantes supprimées<br/>règle : |obs - mean| < 2 * std',
						useHTML: true,
						floating: true
					},
					legend: {
						enabled: false
					},
					xAxis: {
						categories: stats.categories,
						title: {
							text: 'Semestre (Date)'
						}
					},
					yAxis: {
						title: {
							text: 'Observations'
						},
						labels: {
							format: '{value} '+stats.priceType
						}
					},
					series: [{
						name: 'Observations',
						data: stats.data,
						tooltip: {
							headerFormat: '<em>Semestre {point.key}</em><br/>'
						}
					}]

				});
			});

			// reception des données graphiques
			socket.on("data", function(data){
				/*
          - priceType: true=prixAuM2 | false=valeurFonciere
          - dataHouse: Array des prix des maisons
          - dataFlat: Array des prix des Appartements
          - dataOther: Array des prix des autres biens
          - regressions: Array=[reg_maisons,reg_apparts,reg_autres]
          - pentes: Array=[pente_maisons,pente_apparts,pente_autres]
        */


				// initialisation des tableaux du graphe
				Highcharts.chart('graphique1', {
					chart: {
						type: 'scatter',
						zoomType: 'x'
					},
					title: {
						text: 'Prix de l\'immobilier (2014-2018)'
					},

					subtitle: {
						text: 'Source: opendata.gouv.fr'
					},
					xAxis: {
						title: {
							enabled: true,
							text: 'Datetime'
						},
						type: 'datetime'
					},
					yAxis: {
						title: {
							text: 'Prix'
						},
						labels: {
							format: '{value} '+data.priceType
						}
					},
					legend: {
						layout: 'vertical',
						align: 'right',
						verticalAlign: 'middle'
					},
					tooltip: {
						xDateFormat: '%Y-%m-%d',
						shared: true
					},

					plotOptions: {
						scatter: {
							marker: {
								radius: 5,
								states: {
									hover: {
										enabled: true,
										lineColor: 'rgb(100,100,100)'
									}
								}
							},
							states: {
								hover: {
									marker: {
										enabled: false
									}
								}
							},
							tooltip: {
								headerFormat: '<b>{series.name}</b><br>',
								pointFormat: 'date: {point.x}, {point.y} eur'
							}
						},
						series: {
							turboThreshold: 10000
						}
					},

					series: [{
						regression: data.regressions[0],
						regressionSettings: {
							type: 'linear',
							color : 'blue'
						},
						name: 'Maison<br>Pente: '+data.pentes[0],
						data: data.dataHouse,
						color : 'blue',
						dataLabels:{
							formatter: function () { return new Date(this.x).toISOString(); }
						}
					}, {
						regression: data.regressions[1],
						regressionSettings: {
							type: 'linear',
							color : 'red'
						},
						name: 'Appartement<br>Pente: '+data.pentes[1],
						data: data.dataFlat,
						color : 'red'
					}, {
						regression: data.regressions[2],
						regressionSettings: {
							type: 'linear',
							color : 'green'
						},
						name: 'Autre<br>Pente: '+data.pentes[2],
						data: data.dataOther,
						color : 'green'
					}]
				});
			});

        function generateSelect(obj){
          /*
      			- id_select: id du select a creer
      			- optionValues: liste des attributs 'values' a creer dans les <option>
      			- textTab: listes des textes a inserer dans les <option>
      		*/
          // création d'un label + saut de ligne
          if(document.getElementById("lbl_"+obj.id_select)){
            var selectList = document.createElement("select");
        		selectList.setAttribute("id",obj.id_select);

        		obj.optionValues.forEach(function(value){
        			var option = document.createElement("option");
        			option.setAttribute("value",value);
        			option.innerHTML+= obj.textTab[obj.optionValues.indexOf(value)];
        			selectList.appendChild(option);
            });
            document.getElementById("zone1").appendChild(selectList);
          }
          else{
            var label = document.createElement("label");
        		label.setAttribute("for",obj.id_select);
            label.setAttribute("id","lbl_"+obj.id_select);
        		label.innerHTML += "Catégorie: ";
        		const sautLigne = document.createElement("br");
        		// Selection Appartement
        		var selectList = document.createElement("select");
        		selectList.setAttribute("id",obj.id_select);

        		obj.optionValues.forEach(function(value){
        			var option = document.createElement("option");
        			option.setAttribute("value",value);
        			option.innerHTML+= obj.textTab[obj.optionValues.indexOf(value)];
        			selectList.appendChild(option);
            });
            document.getElementById("zone1").appendChild(sautLigne);
            document.getElementById("zone1").appendChild(label);
            document.getElementById("zone1").appendChild(selectList);
          }
        }
        </script>
    </body>
</html>
